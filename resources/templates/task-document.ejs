<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Задание <%= task?.name %> — <%= user?.lastName %> <%= user?.firstName %></title>
  <style>
    @page { size: A4; margin: 15mm 12mm; }
    body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif; color:#111; }
    h1,h2,h3 { margin:0 0 8px; }
    .muted { color:#666; font-size:12px; }
    .row { display:flex; gap:16px; align-items:flex-start; }
    .card { border:1px solid #ddd; border-radius:12px; padding:12px 14px; margin:10px 0; }
    .chip { display:inline-block; border-radius:999px; border:1px solid #e5e5e5; padding:2px 8px; font-size:12px; background:#fafafa; }
    table { width:100%; border-collapse:collapse; margin-top:6px; }
    th,td { border:1px solid #ddd; padding:6px 8px; font-size:13px; vertical-align:top; }
    th { background:#f7f7f7; text-align:left; }
  </style>
</head>
<body>
  <div>
    <h2>Задание: <%= task?.name %></h2>
    <div class="muted">
      Документ #<%= documentId %> • Пользователь:
      <%= user?.lastName %> <%= user?.firstName %> (<%= user?.role %>)
      • Сформировано: <%= now %>
    </div>
    <% if (techCard?.item) { %>
      <div class="muted">Изделие: <%= techCard.item.name %></div>
    <% } %>
  </div>

  <div style="margin-top:12px">
    <% if (steps && steps.length) { %>
      <% steps.forEach(function(s){ %>
        <div class="card">
          <div class="row" style="justify-content:space-between;">
            <div>
              <div><strong>Шаг <%= s.order %>. <%= s.name %></strong></div>
              <div class="muted">
                <% if (s.operation) { %><span class="chip">Операция: <%= s.operation.name %></span><% } %>
                <% if (s.machine) { %><span class="chip">Станок: <%= s.machine.name %></span><% } %>
                <span class="chip">Роль: <%= s.role === 'LEAD' ? 'Главный' : 'Участник' %></span>
                <span class="chip">Кол-во повторов: <%= s.plannedQuantity %></span>
              </div>
            </div>
          </div>

          <% if (s.fields && s.fields.length) { %>
            <div style="margin-top:8px">
              <table>
                <thead><tr><th>Параметр</th><th>Значение</th></tr></thead>
                <tbody>
                  <% s.fields.forEach(function(f){ %>
                    <tr><td><%= f.key %></td><td><%= f.value %></td></tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          <% } %>

          <% if (s.materials && s.materials.length) { %>
            <div style="margin-top:8px">
              <table>
                <thead><tr><th>Материал</th><th>Кол-во</th></tr></thead>
                <tbody>
                  <% s.materials.forEach(function(m){ %>
                    <tr>
                      <td><%= (m.material && m.material.name) || m.name || 'Материал' %></td>
                      <td><%= m.quantity || 1 %> <%= m.unit?.unit || '' %></td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          <% } %>
        </div>
      <% }) %>
    <% } else { %>
      <div class="muted">Для пользователя нет назначенных шагов.</div>
    <% } %>
  </div>
</body>
</html>